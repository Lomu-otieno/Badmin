<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benjamin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Admin Dashboard</h2>
            </div>
            <div class="sidebar-menu">
                <ul>
                    <!-- <li onclick="window.location.href='admin-dashboard.html'">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </li> -->
                    <!-- <li onclick="window.location.href='admin-dashboard.html'">
                        <i class="fas fa-tachometer-alt"></i> Products
                    </li> -->
                    <li onclick="window.location.href='orders.html'">
                        <i class="fas fa-box"></i> Orders
                    </li>
                    <!-- <li>
                        <i class="fas fa-users"></i> Customers
                    </li> -->
                    <li onclick="window.location.href='analytics.html'">
                        <i class="fas fa-chart-bar"></i> Analytics
                    </li>
                    <!-- <li>
                        <i class="fas fa-cog"></i> Settings
                    </li> -->
                </ul>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1>Product Management</h1>
                <div class="user-info">
                    <div class="user-avatar">A</div>
                    <span>Admin User</span>
                    <button class="btn btn-outline" onclick="logout()" style="margin-left: 10px;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
            
            <!-- Products Tab -->
            <div id="products-tab" class="tab-content active">
                <div class="card">
                    <div class="card-header">
                        <h3>All Products</h3>
                        <div>
                            <button class="btn btn-outline">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                            <button class="btn btn-outline">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="products-table-body">
                                <!-- Products will be loaded here -->
                            </tbody>
                        </table>
                        
                        <div class="pagination" id="pagination">
                            <!-- Pagination will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Add Product Tab -->
            <div id="add-product-tab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3>Add New Product</h3>
                    </div>
                    <div class="card-body">
                        <form id="add-product-form">
                            <div class="form-group">
                                <label class="form-label" for="name">Product Name *</label>
                                <input type="text" class="form-control" id="name" name="name" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="description">Description</label>
                                <textarea class="form-control" id="description" name="description"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="price">Price *</label>
                                <input type="number" class="form-control" id="price" name="price" min="0" step="0.01" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="category">Category</label>
                                <input type="text" class="form-control" id="category" name="category">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="stock">Stock</label>
                                <input type="number" class="form-control" id="stock" name="stock" min="0">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="image">Product Image</label>
                                <input type="file" class="form-control" id="image" name="image" accept="image/*">
                                <div class="image-preview" id="image-preview"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="isActive" name="isActive" checked> Active Product
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Create Product
                                </button>
                                <button type="reset" class="btn btn-outline">
                                    <i class="fas fa-undo"></i> Reset
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Product Modal -->
    <div class="modal" id="edit-product-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Product</h3>
                <button class="close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-product-form">
                    <input type="hidden" id="edit-product-id">
                    
                    <div class="form-group">
                        <label class="form-label" for="edit-name">Product Name *</label>
                        <input type="text" class="form-control" id="edit-name" name="name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="edit-description">Description</label>
                        <textarea class="form-control" id="edit-description" name="description"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="edit-price">Price *</label>
                        <input type="number" class="form-control" id="edit-price" name="price" min="0" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="edit-category">Category</label>
                        <input type="text" class="form-control" id="edit-category" name="category">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="edit-stock">Stock</label>
                        <input type="number" class="form-control" id="edit-stock" name="stock" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="edit-image">Add New Image</label>
                        <input type="file" class="form-control" id="edit-image" name="image" accept="image/*">
                        <div class="image-preview" id="edit-image-preview"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="edit-isActive" name="isActive"> Active Product
                        </label>
                    </div>
                </form>
                
                <div id="existing-images">
                    <h4>Existing Images</h4>
                    <div class="image-preview" id="existing-images-preview"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-edit">Cancel</button>
                <button class="btn btn-primary" id="save-product">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal" id="delete-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Deletion</h3>
                <button class="close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this product? This action cannot be undone.</p>
                <p><strong id="delete-product-name"></strong></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-delete">Cancel</button>
                <button class="btn btn-danger" id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://benjamins-shop.onrender.com';
        let authToken = null;
        let currentPage = 1;
        let totalPages = 1;
        let products = [];
        let productToDelete = null;

        // DOM Elements
        const productsTableBody = document.getElementById('products-table-body');
        const pagination = document.getElementById('pagination');
        const addProductForm = document.getElementById('add-product-form');
        const editProductModal = document.getElementById('edit-product-modal');
        const deleteModal = document.getElementById('delete-modal');
        const imagePreview = document.getElementById('image-preview');
        const editImagePreview = document.getElementById('edit-image-preview');
        const existingImagesPreview = document.getElementById('existing-images-preview');
        const imageInput = document.getElementById('image');
        const editImageInput = document.getElementById('edit-image');

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Check authentication
            authToken = localStorage.getItem('adminToken');
            if (!authToken) {
                window.location.href = 'login.html';
                return;
            }
            
            // Load products and setup event listeners
            loadProducts();
            setupEventListeners();
        }

        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.sidebar-menu li').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    if (tabId) {
                        switchTab(tabId);
                    }
                });
            });
            
            // Form submissions
            if (addProductForm) {
                addProductForm.addEventListener('submit', handleAddProduct);
            }
            
            const saveProductBtn = document.getElementById('save-product');
            if (saveProductBtn) {
                saveProductBtn.addEventListener('click', handleEditProduct);
            }
            
            // Image preview
            if (imageInput) {
                imageInput.addEventListener('change', handleImagePreview);
            }
            
            if (editImageInput) {
                editImageInput.addEventListener('change', handleEditImagePreview);
            }
            
            // Modal close buttons
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            });
            
            const cancelEditBtn = document.getElementById('cancel-edit');
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', function() {
                    editProductModal.style.display = 'none';
                });
            }
            
            const cancelDeleteBtn = document.getElementById('cancel-delete');
            if (cancelDeleteBtn) {
                cancelDeleteBtn.addEventListener('click', function() {
                    deleteModal.style.display = 'none';
                });
            }
            
            const confirmDeleteBtn = document.getElementById('confirm-delete');
            if (confirmDeleteBtn) {
                confirmDeleteBtn.addEventListener('click', handleDeleteProduct);
            }
        }

        // Authentication functions
        function getAuthToken() {
            if (!authToken) {
                authToken = localStorage.getItem('adminToken');
            }
            
            if (!authToken) {
                window.location.href = 'login.html';
                throw new Error('No authentication token available');
            }
            
            return authToken;
        }

        function logout() {
            localStorage.removeItem('adminToken');
            window.location.href = 'login.html';
        }

        // Tab switching function
        function switchTab(tabId) {
            // Update active tab in sidebar
            document.querySelectorAll('.sidebar-menu li').forEach(tab => {
                tab.classList.remove('active');
            });
            const activeTab = document.querySelector(`[data-tab="${tabId}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // Show selected tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const tabContent = document.getElementById(tabId);
            if (tabContent) {
                tabContent.classList.add('active');
            }
            
            // If switching to products tab, refresh the products list
            if (tabId === 'products-tab') {
                loadProducts();
            }
        }

        // Load products from API
        async function loadProducts(page = 1) {
            try {
                const token = getAuthToken();
                
                const response = await fetch(`${API_BASE_URL}/api/products/admin/all?page=${page}&limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                if (response.status === 401) {
                    // Token expired or invalid
                    logout();
                    return;
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to load products: ${response.status}`);
                }
                
                const data = await response.json();
                products = data.products || [];
                currentPage = data.currentPage || 1;
                totalPages = data.totalPages || 1;
                
                renderProductsTable();
                renderPagination();
                
            } catch (error) {
                console.error('Error loading products:', error);
                if (error.message.includes('401')) {
                    alert('Session expired. Please login again.');
                    logout();
                } else {
                    alert('Failed to load products: ' + error.message);
                }
            }
        }

        // Render products table
        function renderProductsTable() {
            if (!productsTableBody) return;
            
            productsTableBody.innerHTML = '';
            
            if (products.length === 0) {
                productsTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No products found</td></tr>';
                return;
            }
            
            products.forEach(product => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <img src="${product.images && product.images[0]?.url ? product.images[0].url : 'https://via.placeholder.com/50'}" 
                                 alt="${product.images && product.images[0]?.altText ? product.images[0].altText : product.name}" 
                                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;">
                            <div>
                                <div style="font-weight: 500;">${product.name}</div>
                                <div style="font-size: 12px; color: var(--gray);">${product.description ? product.description.substring(0, 50) + '...' : 'No description'}</div>
                            </div>
                        </div>
                    </td>
                    <td>${product.category || 'Uncategorized'}</td>
                    <td>Ksh ${parseFloat(product.price).toFixed(2)}</td>
                    <td>${product.stock || 0}</td>
                    <td>
                        <span class="badge ${product.isActive ? 'badge-success' : 'badge-danger'}">
                            ${product.isActive ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-outline btn-sm edit-product" data-id="${product._id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline btn-sm delete-product" data-id="${product._id}" data-name="${product.name}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                productsTableBody.appendChild(row);
            });
            
            // Add event listeners to action buttons
            document.querySelectorAll('.edit-product').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    openEditModal(productId);
                });
            });
            
            document.querySelectorAll('.delete-product').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    const productName = this.getAttribute('data-name');
                    openDeleteModal(productId, productName);
                });
            });
        }

        // Render pagination
        function renderPagination() {
            if (!pagination) return;
            
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            const prevBtn = document.createElement('div');
            prevBtn.className = 'page-item';
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            if (currentPage > 1) {
                prevBtn.addEventListener('click', () => loadProducts(currentPage - 1));
            } else {
                prevBtn.style.opacity = '0.5';
                prevBtn.style.cursor = 'not-allowed';
            }
            pagination.appendChild(prevBtn);
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const pageItem = document.createElement('div');
                pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageItem.textContent = i;
                pageItem.addEventListener('click', () => loadProducts(i));
                pagination.appendChild(pageItem);
            }
            
            // Next button
            const nextBtn = document.createElement('div');
            nextBtn.className = 'page-item';
            nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            if (currentPage < totalPages) {
                nextBtn.addEventListener('click', () => loadProducts(currentPage + 1));
            } else {
                nextBtn.style.opacity = '0.5';
                nextBtn.style.cursor = 'not-allowed';
            }
            pagination.appendChild(nextBtn);
        }

        // Handle add product form submission
        async function handleAddProduct(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('name', document.getElementById('name').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('price', document.getElementById('price').value);
            formData.append('category', document.getElementById('category').value);
            formData.append('stock', document.getElementById('stock').value || 0);
            formData.append('isActive', document.getElementById('isActive').checked);
            
            // Add image if selected
            const imageFile = imageInput.files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }
            
            try {
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('Product created successfully!');
                    addProductForm.reset();
                    imagePreview.innerHTML = '';
                    switchTab('products-tab');
                    loadProducts();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || error.message || 'Failed to create product');
                }
            } catch (error) {
                console.error('Error creating product:', error);
                alert('Failed to create product: ' + error.message);
            }
        }

        // Open edit product modal
        async function openEditModal(productId) {
            try {
                const response = await fetch(`${API_BASE_URL}/${productId}`, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch product details');
                }
                
                const product = await response.json();
                
                // Fill form with product data
                document.getElementById('edit-product-id').value = product._id;
                document.getElementById('edit-name').value = product.name;
                document.getElementById('edit-description').value = product.description || '';
                document.getElementById('edit-price').value = product.price;
                document.getElementById('edit-category').value = product.category || '';
                document.getElementById('edit-stock').value = product.stock || 0;
                document.getElementById('edit-isActive').checked = product.isActive;
                
                // Display existing images
                existingImagesPreview.innerHTML = '';
                if (product.images && product.images.length > 0) {
                    product.images.forEach((image, index) => {
                        const imageItem = document.createElement('div');
                        imageItem.className = 'image-preview-item';
                        imageItem.innerHTML = `
                            <img src="${image.url}" alt="${image.altText || product.name}">
                            <button type="button" class="remove-image" data-product-id="${product._id}" data-image-id="${image._id || image.publicId || index}">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        existingImagesPreview.appendChild(imageItem);
                    });
                } else {
                    existingImagesPreview.innerHTML = '<p>No images</p>';
                }
                
                // Clear new image preview
                editImagePreview.innerHTML = '';
                editImageInput.value = '';
                
                // Show modal
                editProductModal.style.display = 'flex';
                
                // Add event listeners to remove image buttons
                document.querySelectorAll('.remove-image').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const productId = this.getAttribute('data-product-id');
                        const imageId = this.getAttribute('data-image-id');
                        removeProductImage(productId, imageId);
                    });
                });
            } catch (error) {
                console.error('Error opening edit modal:', error);
                alert('Failed to load product details: ' + error.message);
            }
        }

        // Handle edit product form submission
        async function handleEditProduct() {
            const productId = document.getElementById('edit-product-id').value;
            const formData = new FormData();
            
            // Add updated fields
            formData.append('name', document.getElementById('edit-name').value);
            formData.append('description', document.getElementById('edit-description').value);
            formData.append('price', document.getElementById('edit-price').value);
            formData.append('category', document.getElementById('edit-category').value);
            formData.append('stock', document.getElementById('edit-stock').value || 0);
            formData.append('isActive', document.getElementById('edit-isActive').checked);
            
            // Add new image if selected
            const imageFile = editImageInput.files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('Product updated successfully!');
                    editProductModal.style.display = 'none';
                    loadProducts();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || error.message || 'Failed to update product');
                }
            } catch (error) {
                console.error('Error updating product:', error);
                alert('Failed to update product: ' + error.message);
            }
        }

        // Remove product image
        async function removeProductImage(productId, imageId) {
            if (!confirm('Are you sure you want to remove this image?')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/${productId}/images/${imageId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                
                if (response.ok) {
                    const imageElement = document.querySelector(`.remove-image[data-image-id="${imageId}"]`);
                    if (imageElement) {
                        imageElement.closest('.image-preview-item').remove();
                    }
                    alert('Image deleted successfully!');
                } else {
                    const error = await response.json();
                    throw new Error(error.error || error.message || 'Failed to remove image');
                }
            } catch (error) {
                console.error('Error removing image:', error);
                alert('Failed to remove image: ' + error.message);
            }
        }

        // Open delete confirmation modal
        function openDeleteModal(productId, productName) {
            productToDelete = productId;
            document.getElementById('delete-product-name').textContent = productName;
            deleteModal.style.display = 'flex';
        }

        // Handle product deletion
        async function handleDeleteProduct() {
            if (!productToDelete) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/${productToDelete}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                
                if (response.ok) {
                    alert('Product deleted successfully!');
                    deleteModal.style.display = 'none';
                    loadProducts();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || error.message || 'Failed to delete product');
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Failed to delete product: ' + error.message);
            }
        }

        // Handle image preview for add product form
        function handleImagePreview() {
            imagePreview.innerHTML = '';
            
            const files = imageInput.files;
            if (files.length === 0) return;
            
            const file = files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-preview-item';
                imageItem.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <button type="button" class="remove-image" onclick="removePreviewImage(this)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                imagePreview.appendChild(imageItem);
            };
            
            reader.readAsDataURL(file);
        }

        // Handle image preview for edit product form
        function handleEditImagePreview() {
            editImagePreview.innerHTML = '';
            
            const files = editImageInput.files;
            if (files.length === 0) return;
            
            const file = files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-preview-item';
                imageItem.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <button type="button" class="remove-image" onclick="removeEditPreviewImage(this)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                editImagePreview.appendChild(imageItem);
            };
            
            reader.readAsDataURL(file);
        }

        // Remove preview image (add form)
        function removePreviewImage(button) {
            button.closest('.image-preview-item').remove();
            imageInput.value = '';
        }

        // Remove preview image (edit form)
        function removeEditPreviewImage(button) {
            button.closest('.image-preview-item').remove();
            editImageInput.value = '';
        }
    </script>
</body>
</html>